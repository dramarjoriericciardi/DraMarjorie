<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsiManager 360 - Dra. Marjorie Ricciardi</title>
    
    <!-- Scripts Visuais -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- FIREBASE (O Motor da Nuvem) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .nav-item.active { background-color: #e0f2fe; color: #0369a1; border-right: 4px solid #0284c7; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-action { transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20 card-shadow">
        <div class="p-6 border-b border-slate-100">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">PsiManager<span class="text-sky-600">360</span></h1>
            <p class="text-xs text-slate-500 mt-1">Gest√£o de Telemedicina</p>
        </div>

        <div class="p-4 space-y-2">
            <button onclick="openImportModal()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2 text-sm btn-action">
                <span>üì•</span> Importar Lista do Dia
            </button>
            <button onclick="exportToCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2 text-xs btn-action">
                <span>üìä</span> Baixar Planilha (Excel)
            </button>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-2">
            <ul class="space-y-1">
                <li><button onclick="router('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors flex items-center group active"><span class="text-lg mr-3 group-hover:text-sky-600">üìä</span> Vis√£o Geral</button></li>
                <li><button onclick="router('patients')" id="nav-patients" class="nav-item w-full text-left px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors flex items-center group"><span class="text-lg mr-3 group-hover:text-sky-600">üë•</span> Pacientes (360¬∞)</button></li>
                <li><button onclick="router('alerts')" id="nav-alerts" class="nav-item w-full text-left px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors flex items-center group"><span class="text-lg mr-3 group-hover:text-slate-500">‚ö†Ô∏è</span> Alertas</button></li>
            </ul>
        </nav>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50 flex items-center">
            <div class="w-8 h-8 rounded-full bg-sky-100 flex items-center justify-center text-sky-700 font-bold relative">
                Dr
                <span id="connection-status" class="absolute bottom-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full" title="Desconectado"></span>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-slate-700">Dra. Marjorie Ricciardi</p>
                <p class="text-xs text-slate-500" id="status-text">Conectando Nuvem...</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center z-10">
            <h1 class="font-bold text-slate-800">PsiManager<span class="text-sky-600">360</span></h1>
            <button onclick="toggleMobileMenu()" class="text-slate-600 text-xl">‚ò∞</button>
        </header>

        <div id="mobile-menu" class="fixed inset-0 bg-slate-800 bg-opacity-90 z-50 hidden md:hidden flex flex-col justify-center items-center space-y-6">
            <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 text-white text-2xl">‚úï</button>
            <button onclick="openImportModal(); toggleMobileMenu()" class="text-emerald-300 text-xl font-bold">üì• Importar Lista</button>
            <button onclick="router('dashboard'); toggleMobileMenu()" class="text-white text-xl">Vis√£o Geral</button>
            <button onclick="router('patients'); toggleMobileMenu()" class="text-white text-xl">Pacientes</button>
        </div>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="fade-in space-y-6">
                <div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Painel de Controle (Nuvem)</h2><p class="text-slate-500 mt-1">Gest√£o de agendamentos e status da cl√≠nica.</p></div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-lg border border-slate-200 card-shadow">
                        <div class="flex justify-between items-start"><div><p class="text-xs font-semibold text-slate-400 uppercase">Total Pacientes</p><h3 class="text-3xl font-bold text-slate-700 mt-2" id="kpi-total">...</h3></div><span class="text-2xl text-slate-400">üìÇ</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-lg border border-slate-200 card-shadow border-l-4 border-l-sky-500">
                        <div class="flex justify-between items-start"><div><p class="text-xs font-semibold text-slate-400 uppercase">J√° Agendados</p><h3 class="text-3xl font-bold text-sky-600 mt-2" id="kpi-scheduled">...</h3></div><span class="text-2xl text-sky-500">üìÖ</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-lg border border-slate-200 card-shadow border-l-4 border-l-amber-400">
                        <div class="flex justify-between items-start"><div><p class="text-xs font-semibold text-slate-400 uppercase">Fila para Agendar</p><h3 class="text-3xl font-bold text-amber-600 mt-2" id="kpi-pending">...</h3></div><span class="text-2xl text-amber-500">‚è≥</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-lg border border-slate-200 card-shadow border-l-4 border-l-slate-500">
                        <div class="flex justify-between items-start"><div><p class="text-xs font-semibold text-slate-400 uppercase">Inativos (>90d)</p><h3 class="text-3xl font-bold text-slate-600 mt-2" id="kpi-inactive">...</h3></div><span class="text-2xl text-slate-500">üí§</span></div>
                    </div>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg overflow-hidden shadow-sm mt-6">
                    <div class="p-4 bg-amber-100 border-b border-amber-200 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">üìù</span>
                            <h3 class="font-bold text-amber-900">Fila de Agendamento (Secret√°ria)</h3>
                        </div>
                        <span class="text-xs text-amber-700 font-medium">Estes pacientes precisam de hor√°rio</span>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-amber-50 text-amber-900 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-4">Paciente</th>
                                    <th class="p-4">Retorno Ideal</th>
                                    <th class="p-4">√öltima Consulta</th>
                                    <th class="p-4 text-right">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="scheduling-queue-body" class="text-sm divide-y divide-amber-100 bg-white">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                        <div id="empty-queue-msg" class="p-8 text-center text-slate-400 hidden">
                            Carregando dados da nuvem...
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-lg border border-slate-200 card-shadow">
                        <h3 class="font-bold text-slate-700 mb-4">Status da Carteira</h3>
                        <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- PATIENTS 360 -->
            <section id="view-patients" class="hidden fade-in space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Pacientes (360¬∞)</h2>
                        <p class="text-slate-500">Gest√£o completa e hist√≥rico.</p>
                    </div>
                    <input type="text" id="patient-search" placeholder="üîç Buscar..." class="w-full md:w-64 px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <div class="bg-white rounded-lg border border-slate-200 card-shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                                <tr class="border-b border-slate-200">
                                    <th class="p-4">Paciente</th>
                                    <th class="p-4">√öltima Consulta</th>
                                    <th class="p-4">Retorno Sugerido</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Situa√ß√£o</th>
                                    <th class="p-4 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="patients-table-body" class="text-sm divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 text-xs text-slate-500"><span id="patient-count-footer">...</span></div>
                </div>
            </section>

            <!-- ALERTS -->
            <section id="view-alerts" class="hidden fade-in space-y-8">
                <h2 class="text-2xl font-bold text-slate-800">Central de Alertas</h2>
                <div class="bg-amber-50 rounded-lg border border-amber-200 p-6">
                    <div class="flex items-center gap-3 mb-4"><span class="text-2xl">‚ö†Ô∏è</span><h3 class="text-lg font-bold text-amber-800">Atraso de Retorno (> 30 Dias)</h3></div>
                    <div class="bg-white rounded border border-amber-100 overflow-hidden"><table class="w-full text-left"><tbody id="alert-30-body" class="text-sm"></tbody></table></div>
                </div>
                <div class="bg-slate-100 rounded-lg border border-slate-200 p-6">
                    <div class="flex items-center gap-3 mb-4"><span class="text-2xl">üí§</span><h3 class="text-lg font-bold text-slate-700">Inativos (> 90 Dias ou Desistentes)</h3></div>
                    <div class="bg-white rounded border border-slate-200 overflow-hidden"><table class="w-full text-left"><tbody id="alert-90-body" class="text-sm"></tbody></table></div>
                </div>
            </section>
        </div>
    </main>

    <!-- MODAL: IMPORT -->
    <div id="modal-import" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh] animate-bounce-in">
            <div class="bg-emerald-600 p-4 flex justify-between items-center rounded-t-lg">
                <h3 class="text-white font-bold text-lg">üì• Importar Lista do Dia (Nuvem)</h3>
                <button onclick="closeImportModal()" class="text-emerald-100 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <p class="text-sm text-slate-600 mb-2">Cole a lista di√°ria. Os dados ser√£o enviados para o banco de dados seguro.</p>
                <textarea id="import-text" class="w-full h-48 border border-slate-300 rounded-lg p-3 font-mono text-xs focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="RETORNOS 03/12/2025&#10;&#10;*Nara Carpinelli. HD: F31. RET EM 2M (EM 30')&#10;..."></textarea>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeImportModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancelar</button>
                <button onclick="processImport()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded font-medium shadow btn-action">Enviar para Nuvem</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <span id="toast-icon">‚úÖ</span>
        <span id="toast-msg">Mensagem</span>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION (SUAS CHAVES) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ8fwhLOrCjrJWEjTMWaWgcZYSY-p_hbA",
            authDomain: "psimanager-dramarjorie.firebaseapp.com",
            projectId: "psimanager-dramarjorie",
            storageBucket: "psimanager-dramarjorie.firebasestorage.app",
            messagingSenderId: "1056688238572",
            appId: "1:1056688238572:web:9cec66bcdaaf23d3b19ac9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. LOCAL MIRROR (Data flows from Cloud -> Here -> UI) ---
        let patientData = []; 
        const TODAY = new Date();

        // --- 3. REAL-TIME LISTENER (THE MAGIC) ---
        function initRealTimeConnection() {
            // Listen to "pacientes" collection
            db.collection("pacientes").onSnapshot((querySnapshot) => {
                patientData = []; // Wipe local mirror
                querySnapshot.forEach((doc) => {
                    // Add Cloud ID to the object
                    patientData.push({ id: doc.id, ...doc.data() });
                });
                
                // Update UI Status
                document.getElementById('connection-status').className = "absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full";
                document.getElementById('status-text').textContent = "Online ‚Ä¢ Sincronizado";
                document.getElementById('connection-status').title = "Conectado ao Google Cloud";

                renderAll(); // Re-render everything with new data
            }, (error) => {
                console.error("Erro na conex√£o:", error);
                document.getElementById('status-text').textContent = "Erro na Conex√£o";
                document.getElementById('connection-status').className = "absolute bottom-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full";
            });
        }

        // --- 4. CLOUD ACTIONS (WRITE TO CLOUD) ---
        
        // Import Logic
        async function processImport() {
            const text = document.getElementById('import-text').value;
            const lines = text.split('\n');
            let consultDate = null;
            let importedCount = 0;

            const dateRegex = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/;
            for(let i=0; i<5; i++) {
                if(lines[i] && dateRegex.test(lines[i])) {
                    const match = lines[i].match(dateRegex);
                    let year = parseInt(match[3]);
                    if (year < 100) year += 2000;
                    consultDate = new Date(year, parseInt(match[2])-1, parseInt(match[1]));
                    break;
                }
            }

            if (!consultDate) { alert("Erro: Data n√£o encontrada no cabe√ßalho."); return; }

            const rowRegex = /^(\*?)(.*?)(?:[\.\s]*?)HD[:\s]+(.*?)(?:[\.\s]*?)RET(?:.*?)(?:EM)?\s+(.*?)\s*\((?:EM)?\s*(\d+)/i;
            const batchPromises = [];

            for (const line of lines) {
                const cleanLine = line.trim();
                if (!cleanLine) continue;
                const match = cleanLine.match(rowRegex);
                
                if (match) {
                    const hasAsterisk = match[1] === '*';
                    let name = match[2].trim();
                    const cid = match[3].trim();
                    const retTimeStr = match[4].trim(); 
                    const duration = parseInt(match[5]);

                    // Calculate Return
                    let daysToAdd = 30; 
                    if (retTimeStr.toUpperCase().includes('M')) {
                        const months = parseInt(retTimeStr.replace(/\D/g, '')) || 1;
                        daysToAdd = months * 30;
                    } else if (retTimeStr.toLowerCase().includes('d')) {
                        const days = parseInt(retTimeStr.replace(/\D/g, '')) || 30;
                        daysToAdd = days;
                    }
                    const returnDueDate = addDaysToDate(consultDate, daysToAdd);
                    
                    // Check if exists in current loaded data
                    const existing = patientData.find(p => p.name.replace('*','').trim().toLowerCase() === name.replace('*','').trim().toLowerCase());

                    if (existing) {
                        // Update Existing
                        if(hasAsterisk && !existing.name.includes('*')) name = "*" + name; // Update name to include * if new
                        else name = existing.name;

                        batchPromises.push(
                            db.collection("pacientes").doc(existing.id).update({
                                lastConsult: dateToYYYYMMDD(consultDate),
                                returnDue: dateToYYYYMMDD(returnDueDate),
                                cid: cid,
                                duration: duration,
                                status: "Ativo",
                                schedulingStatus: "pendente",
                                name: name
                            })
                        );
                    } else {
                        // Create New
                        if(hasAsterisk) name = "*" + name;
                        batchPromises.push(
                            db.collection("pacientes").add({
                                name: name,
                                lastConsult: dateToYYYYMMDD(consultDate),
                                returnDue: dateToYYYYMMDD(returnDueDate),
                                cid: cid,
                                duration: duration,
                                status: "Ativo",
                                schedulingStatus: "pendente"
                            })
                        );
                    }
                    importedCount++;
                }
            }

            // Execute all updates
            Promise.all(batchPromises).then(() => {
                closeImportModal();
                alert(`Sucesso! ${importedCount} pacientes processados e sincronizados.`);
            }).catch(err => {
                alert("Erro ao salvar na nuvem: " + err.message);
            });
        }

        function markAsScheduled(id) {
            db.collection("pacientes").doc(id).update({ schedulingStatus: 'agendado' })
                .then(() => showToast(`Agendado com sucesso!`, "‚úÖ"));
        }

        function markAsUnscheduled(id) {
            if(confirm("O paciente desmarcou? Ele voltar√° para a fila.")) {
                // UI feedback instantaneo (opcional, o listener j√° faz isso r√°pido)
                showToast(`Voltando para fila...`, "‚Ü©Ô∏è");
                
                db.collection("pacientes").doc(id).update({ schedulingStatus: 'pendente' })
                    .then(() => {
                        setTimeout(() => { router('dashboard'); }, 800);
                    });
            }
        }

        function markAsDropout(id) {
            if(confirm("Confirmar desist√™ncia? Mover para Inativos.")) {
                db.collection("pacientes").doc(id).update({ status: 'Inativo', schedulingStatus: 'pendente' })
                    .then(() => showToast(`Movido para Inativos.`, "üö´"));
            }
        }

        // --- 5. EXPORT (READ FROM LOCAL MIRROR) ---
        function exportToCSV() {
            if (patientData.length === 0) { alert("Sem dados para exportar."); return; }
            const headers = ["ID_Nuvem", "Paciente", "Ultima_Consulta", "Retorno_Sugerido", "Status", "Situacao_Agenda", "CID", "Duracao_Min"];
            const rows = patientData.map(p => [ p.id, `"${p.name}"`, p.lastConsult, p.returnDue, p.status, p.schedulingStatus, p.cid, p.duration ]);
            const csvContent = headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `PsiManager_Export_${dateToYYYYMMDD(TODAY)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- HELPERS ---
        function getDaysDiff(dateString) {
            if (!dateString) return 999;
            const diffTime = TODAY - new Date(dateString);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        function getReturnDelay(returnDueStr) {
            if (!returnDueStr) return 0;
            const diffTime = TODAY - new Date(returnDueStr);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }
        function addDaysToDate(dateObj, days) {
            const result = new Date(dateObj);
            result.setDate(result.getDate() + days);
            return result;
        }
        function dateToYYYYMMDD(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function showToast(msg, icon) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            document.getElementById('toast-icon').textContent = icon;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        // --- RENDERERS (SAME AS BEFORE) ---
        Chart.register(ChartDataLabels);

        function renderAll() {
            renderKPIs();
            renderDashboardQueue();
            renderCharts();
            const term = document.getElementById('patient-search').value.toLowerCase();
            renderPatientTable(term);
            renderAlerts();
        }

        function renderDashboardQueue() {
            const tbody = document.getElementById('scheduling-queue-body');
            const emptyMsg = document.getElementById('empty-queue-msg');
            tbody.innerHTML = '';
            const queue = patientData.filter(p => p.schedulingStatus === 'pendente' && p.status !== 'Inativo');

            if (queue.length === 0) {
                emptyMsg.classList.remove('hidden'); emptyMsg.textContent = "Nenhum paciente pendente! üéâ";
            } else {
                emptyMsg.classList.add('hidden');
                queue.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-amber-50 transition-colors";
                    row.innerHTML = `<td class="p-4 font-medium text-slate-800">${p.name}</td><td class="p-4 font-bold text-slate-600">${formatDate(p.returnDue)}</td><td class="p-4 text-slate-500">${formatDate(p.lastConsult)}</td><td class="p-4 text-right"><button onclick="markAsScheduled('${p.id}')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow btn-action">‚úÖ J√° Agendei</button></td>`;
                    tbody.appendChild(row);
                });
            }
        }

        function renderKPIs() {
            const total = patientData.length;
            const scheduled = patientData.filter(p => p.schedulingStatus === 'agendado' && p.status !== 'Inativo').length;
            const pending = patientData.filter(p => p.schedulingStatus === 'pendente' && p.status !== 'Inativo').length;
            let inactive90 = 0;
            patientData.forEach(p => { if (p.status === 'Inativo' || getDaysDiff(p.lastConsult) > 90) inactive90++; });
            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-scheduled').textContent = scheduled;
            document.getElementById('kpi-pending').textContent = pending;
            document.getElementById('kpi-inactive').textContent = inactive90;
        }

        function renderPatientTable(filterTerm = "") {
            const tbody = document.getElementById('patients-table-body');
            tbody.innerHTML = '';
            const filteredData = patientData.filter(p => p.name.toLowerCase().includes(filterTerm));
            document.getElementById('patient-count-footer').textContent = `${filteredData.length} pacientes`;

            filteredData.forEach(p => {
                const daysAbsent = getDaysDiff(p.lastConsult);
                let displayStatus = p.status;
                if (daysAbsent > 90) displayStatus = "Inativo";
                let statusBadge = displayStatus === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600';
                let scheduleBadge = p.schedulingStatus === 'agendado' ? '<span class="px-2 py-1 rounded bg-sky-100 text-sky-700 text-xs font-bold">Agendado</span>' : '<span class="px-2 py-1 rounded bg-amber-100 text-amber-700 text-xs font-bold">Pendente</span>';
                let actionBtn = p.schedulingStatus === 'agendado' 
                    ? `<button onclick="markAsUnscheduled('${p.id}')" class="text-rose-500 hover:text-rose-700 text-xs font-bold border border-rose-200 hover:bg-rose-50 px-2 py-1 rounded btn-action">‚ùå Desmarcou</button>` 
                    : `<button onclick="markAsScheduled('${p.id}')" class="text-emerald-600 hover:text-emerald-700 text-xs font-bold border border-emerald-200 hover:bg-emerald-50 px-2 py-1 rounded btn-action">‚úÖ Agendar</button>`;

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0";
                row.innerHTML = `<td class="p-4 font-medium text-slate-800">${p.name}<div class="text-xs text-slate-400">CID: ${p.cid || '-'} ‚Ä¢ ${p.duration || '?'} min</div></td><td class="p-4 text-slate-600">${formatDate(p.lastConsult)}</td><td class="p-4 text-slate-800 font-medium">${formatDate(p.returnDue)}</td><td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusBadge}">${displayStatus}</span></td><td class="p-4">${scheduleBadge}</td><td class="p-4 text-right">${actionBtn}</td>`;
                tbody.appendChild(row);
            });
        }

        function renderCharts() {
            let pendingCount = 0, inactiveCount = 0, activeScheduledCount = 0;
            patientData.forEach(p => {
                const daysAbsent = getDaysDiff(p.lastConsult);
                if (p.status === 'Inativo' || daysAbsent > 90) inactiveCount++;
                else if (p.schedulingStatus === 'pendente') pendingCount++;
                else activeScheduledCount++;
            });
            if(window.myStatusChart) window.myStatusChart.destroy();
            const ctxStatus = document.getElementById('chartStatus').getContext('2d');
            window.myStatusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: { labels: ['Agendados/Em dia', 'Fila Pendente', 'Inativos'], datasets: [{ data: [activeScheduledCount, pendingCount, inactiveCount], backgroundColor: ['#0ea5e9', '#f59e0b', '#64748b'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', font: {weight:'bold'}, formatter: (v) => v || '' } } }
            });
        }

        function renderAlerts() {
            const list30 = document.getElementById('alert-30-body');
            const list90 = document.getElementById('alert-90-body');
            list30.innerHTML = ''; list90.innerHTML = '';
            patientData.forEach(p => {
                const daysAbsent = getDaysDiff(p.lastConsult);
                const delay = getReturnDelay(p.returnDue);
                if (p.status === 'Inativo' || daysAbsent > 90) {
                    list90.innerHTML += `<tr class="border-b border-slate-200 hover:bg-white"><td class="p-3 font-medium text-slate-700">${p.name}</td><td class="p-3 font-bold text-slate-600">${daysAbsent > 90 ? daysAbsent + ' dias ausente' : 'Inativo Manual'}</td></tr>`;
                } else if (delay > 30 && p.schedulingStatus === 'pendente') {
                    list30.innerHTML += `<tr class="border-b border-amber-100 hover:bg-white"><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-slate-500">${formatDate(p.returnDue)}</td><td class="p-3 font-bold text-amber-600">${delay} dias atraso</td><td class="p-3 text-right"><button onclick="markAsDropout('${p.id}')" class="text-xs bg-rose-100 text-rose-700 px-2 py-1 rounded hover:bg-rose-200 font-bold">üö´ Desist√™ncia</button></td></tr>`;
                }
            });
        }

        function router(viewName) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');
            ['dashboard', 'patients', 'alerts'].forEach(sec => document.getElementById(`view-${sec}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
        }
        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }

        // Start
        initRealTimeConnection();
        init();
    </script>
</body>
</html>